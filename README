HSM in a C++ template.

Your HSM class needs to use the template.  The template header is fairly
well commented, and testhsm.cc and testhsm.hh contain an example class.
